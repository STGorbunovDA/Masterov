@inject IJSRuntime Js
@inject NavigationManager Navigation

<div class="search-popup @(_isVisible ? "is-visible" : "")">
    <div class="search-popup-container">
        <form role="search" method="get" class="search-form" @onsubmit="HandleSearch">
            <input type="search" 
                   id="search-form" 
                   class="search-field"
                   placeholder="Type and press enter" 
                   value="@_searchText"
                   @oninput="OnSearchInput"
                   @onkeydown="HandleKeyDown"
                   name="s" />
            <button type="submit" class="search-submit">
                <svg class="search"><use xlink:href="#search"></use></svg>
            </button>
        </form>

        <h5 class="cat-list-title">Browse Categories</h5>

        <ul class="cat-list">
            @foreach (var category in _categories)
            {
                <li class="cat-list-item">
                    <a href="#" @onclick="() => SearchCategory(category)">
                        @category
                    </a>
                </li>
            }
        </ul>

    </div>
</div>

@code {
    private bool _isVisible = false;
    private string _searchText = "";
    
    private List<string> _categories =
    [
        "Mobile Phones", "Smart Watches", "Headphones",
        "Accessories", "Monitors", "Speakers", "Memory Cards"
    ];
    
    private void CloseSearch()
    {
        _isVisible = false;
        _searchText = "";
        StateHasChanged();
    }
    
    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchText = e.Value?.ToString() ?? "";
    }
    
    private void HandleSearch()
    {
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            // Редирект на страницу поиска с результатами
            var encodedQuery = Uri.EscapeDataString(_searchText);
            Navigation.NavigateTo($"/search?q={encodedQuery}");
            CloseSearch();
        }
    }
    
    private void SearchCategory(string category)
    {
        // Редирект на страницу с фильтром по категории
        var encodedCategory = Uri.EscapeDataString(category);
        Navigation.NavigateTo($"/shop?category={encodedCategory}");
        CloseSearch();
    }
    
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            HandleSearch();
        }
        else if (e.Key == "Escape")
        {
            CloseSearch();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Регистрируем глобальные обработчики
            await Js.InvokeVoidAsync("initSearchPopup", 
                DotNetObjectReference.Create(this));
        }
    }
    
    // Метод для вызова из JavaScript
    [JSInvokable]
    public void GetCloseFromJs()
    {
        CloseSearch();
    }
}